name: Build Kernel
permissions:
  contents: write
  actions: write

on:
  workflow_dispatch:
    inputs:
      target_devices:
        description: 'target device (ç›®æ ‡è®¾å¤‡)'
        required: true
        type: choice
        options:
          - 'umi'
          - 'cmi'
          - 'cas'
          - 'thyme'
          - 'munch'
          - 'dagu'
          - 'elish'
          - 'enuma'
          - 'alioth'
          - 'apollo'
          - 'lmi'
          - 'psyche'
          - 'pipa'
          - 'all'
      compiled_system:
        description: 'Applicable systems (é€‚ç”¨ç³»ç»Ÿ)'
        required: true
        type: choice
        default: 'MIUI'
        options:
          - 'MIUI'
          - 'AOSP'
      kernelsu_variant:
        description: 'KernelSU variants (KernelSU ç‰ˆæœ¬)'
        required: true
        type: choice
        default: 'SukiSU-Ultra'
        options:
          - 'SukiSU-Ultra'
          - 'RKSU'
          - 'KernelSU'
          - 'None'
      kpm_enable:
        description: 'Is KPM support enabled? (æ˜¯å¦å¯ç”¨ KPM æ”¯æŒ?)'
        required: true
        type: choice
        default: 'enable'
        options:
          - 'enable'
          - 'disable'
      kernel_version:
        description: 'Customizing the kernel version number (è‡ªå®šä¹‰å†…æ ¸ç‰ˆæœ¬å·)'
        required: false
        type: string
        default: ''
      build_type:
        description: 'Kernel Build Type (å†…æ ¸æ„å»ºç±»å‹)'
        required: true
        type: choice
        default: 'Release'
        options:
          - 'Release'
          - 'Dev'

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - id: set-matrix
        run: |
          DEVICES="${{ github.event.inputs.target_devices }}"
          if [ "$DEVICES" == "all" ]; then
            DEVICES="umi,cmi,cas,thyme,munch,dagu,elish,enuma,alioth,apollo,lmi,psyche,pipa"
          fi
          DEVICES_JSON="[$(echo $DEVICES | sed 's/,/","/g' | sed 's/.*/"&"/')]"
          echo "matrix={\"device\":$DEVICES_JSON}" >> $GITHUB_OUTPUT

  build:
    needs: prepare
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
    strategy:
      matrix: ${{fromJson(needs.prepare.outputs.matrix)}}
      fail-fast: false
    env:
      CCACHE_COMPILERCHECK: "%compiler% -dumpmachine; %compiler% -dumpversion"
      CCACHE_NOHASHDIR: "true"
      CCACHE_HARDLINK: "true"
      WORKDIR: "${{ github.workspace }}"
      KERNEL_SOURCE: "${{ github.workspace }}/kernel_source"
      TOOLCHAIN_DIR: "${{ github.workspace }}/toolchain"
      DEVICE: "${{ matrix.device }}"

    steps:
      - name: ğŸ“¢ Build Information (æ„å»ºä¿¡æ¯)
        run: |
          echo "è®¾å¤‡: ${DEVICE} | ç³»ç»Ÿ: ${{ github.event.inputs.compiled_system }}"
          echo "KernelSUå˜ä½“: ${{ github.event.inputs.kernelsu_variant }} | KPM: ${{ github.event.inputs.kpm_enable }}"
          echo "æ„å»ºç±»å‹: ${{ github.event.inputs.build_type }}"

      - name: ğŸš€ Maximize build space (æœ€å¤§åŒ–æ„å»ºç©ºé—´)
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192
          temp-reserve-mb: 2048
          swap-size-mb: 8192
          remove-dotnet: "true"
          remove-android: "true"
          remove-haskell: "true"
          remove-codeql: "true"

      - name: ğŸ“¦ Installation of dependencies (å®‰è£…ä¾èµ–)
        run: |
          echo "æ­£åœ¨å®‰è£…æ„å»ºä¾èµ–..."
          sudo apt update && sudo apt upgrade -y
          sudo apt install -y \
            bc binutils-dev bison build-essential ca-certificates ccache cmake curl file flex \
            git libelf-dev libssl-dev make ninja-build python3-dev texinfo u-boot-tools xz-utils \
            zlib1g-dev libncurses-dev wget zip cpio python3 python3-pip tree gcc clang lld llvm jq
          echo "âœ… Dependency installation complete (ä¾èµ–å®‰è£…å®Œæˆ)"
          
      - name: âš™ï¸ Configuring ccache (é…ç½® ccache)
        run: |
          mkdir -p ~/.cache
          ccache --version
          ccache --max-size=4G
          ccache --set-config=compression=true
          ccache --zero-stats
          echo "CCACHE_DIR=$HOME/.cache" >> $GITHUB_ENV
          
      - name: ğŸ“¥ Restore ccache (æ¢å¤ ccache ç¼“å­˜)
        uses: actions/cache@v4
        with:
          path: ~/.cache
          key: ccache-${{ github.event.inputs.compiled_system }}-${{ hashFiles('**/Makefile') }}
          restore-keys: |
            ccache-${{ github.event.inputs.compiled_system }}-
            ccache-
            
      - name: ğŸ“¥ Cloning kernel source code ï¼ˆå…‹éš†å†…æ ¸æºç ï¼‰
        run: |
          echo "æ­£åœ¨å…‹éš†å†…æ ¸æºç ..."
          git clone https://github.com/nobbs00/nikokernel_xiaomi_sm8250_mod_new.git --depth=1 $KERNEL_SOURCE
          echo "âœ… Kernel source code cloning complete (å†…æ ¸æºç å…‹éš†å®Œæˆ)"

      - name: ğŸ“¥ Caching toolchain (ç¼“å­˜å·¥å…·é“¾)
        id: cache-toolchain
        uses: actions/cache@v4
        with:
          path: ${{ env.TOOLCHAIN_DIR }}
          key: toolchain-clang-r547379-gcc-${{ hashFiles('**/*.sh') }}
          restore-keys: |
            toolchain-clang-r547379-gcc-
            toolchain-
            
      - name: ğŸ“¥ Download the compilation toolchain (ä¸‹è½½ç¼–è¯‘å·¥å…·é“¾)
        if: steps.cache-toolchain.outputs.cache-hit != 'true'
        run: |
          echo "æ­£åœ¨ä¸‹è½½ç¼–è¯‘å·¥å…·é“¾..."
          # åˆ›å»ºå·¥å…·é“¾ç›®å½•
          mkdir -p "$TOOLCHAIN_DIR/clang"
          mkdir -p "$TOOLCHAIN_DIR/gcc/gcc64"
          mkdir -p "$TOOLCHAIN_DIR/gcc/gcc32"
          
          # ä¸‹è½½ Clang
          echo "æ­£åœ¨ä¸‹è½½ Clang..."
          cd "$TOOLCHAIN_DIR/clang"
          wget -q https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/main/clang-r547379.tar.gz -O clang-r547379.tar.gz
          tar -xzf clang-r547379.tar.gz
          rm clang-r547379.tar.gz
          
          # ä¸‹è½½ GCC
          echo "æ­£åœ¨ä¸‹è½½ GCCå·¥å…·é“¾..."
          cd "$TOOLCHAIN_DIR/gcc/gcc64"
          git init
          git remote add origin https://github.com/LineageOS/android_prebuilts_gcc_linux-x86_aarch64_aarch64-linux-android-4.9.git
          git fetch --depth 1 origin
          git checkout FETCH_HEAD
          
          cd "$TOOLCHAIN_DIR/gcc/gcc32"
          git init
          git remote add origin https://github.com/LineageOS/android_prebuilts_gcc_linux-x86_arm_arm-linux-androideabi-4.9.git
          git fetch --depth 1 origin
          git checkout FETCH_HEAD
          
          echo "âœ… Toolchain download complete (å·¥å…·é“¾ä¸‹è½½å®Œæˆ)"

      - name: âš™ï¸ Configuring KernelSU (é…ç½® KernelSU)
        run: |
          cd "$KERNEL_SOURCE"
          
          KSU_VARIANT="${{ github.event.inputs.kernelsu_variant }}"
          
          echo "âš™ï¸ Configure KernelSU Variants: $KSU_VARIANT (é…ç½® KernelSU å˜ä½“: $KSU_VARIANT)"
          
          if [ "$KSU_VARIANT" == "SukiSU-Ultra" ]; then
            curl -LSs "https://raw.githubusercontent.com/ShirkNeko/SukiSU-Ultra/susfs-dev/kernel/setup.sh" | bash -s susfs-dev
          elif [ "$KSU_VARIANT" == "RKSU" ]; then
            curl -LSs "https://raw.githubusercontent.com/rsuntk/KernelSU/susfs-v1.5.5/kernel/setup.sh" | bash -s susfs-v1.5.5
          elif [ "$KSU_VARIANT" == "KernelSU" ]; then
            curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -s v0.9.5
          else
            echo "KernelSU Disabled (KernelSU å·²ç¦ç”¨)"
          fi
          
          echo "âœ… KernelSU configuration complete (KernelSU é…ç½®å®Œæˆ)"
          
      - name: ğŸ”¨ Build the kernel (æ„å»ºå†…æ ¸)
        run: |
          cd "$KERNEL_SOURCE"
          
          # è®¾ç½®ç¯å¢ƒå˜é‡
          export PATH="$TOOLCHAIN_DIR/clang/bin:$PATH"
          
          # å®šä¹‰æ„å»ºå‚æ•°
          MAKE_ARGS="ARCH=arm64 SUBARCH=arm64 LLVM=1 LLVM_IAS=1 \
            CROSS_COMPILE=$TOOLCHAIN_DIR/gcc/gcc64/bin/aarch64-linux-android- \
            CROSS_COMPILE_COMPAT=$TOOLCHAIN_DIR/gcc/gcc32/bin/arm-linux-androideabi- \
            CROSS_COMPILE_ARM32=$TOOLCHAIN_DIR/gcc/gcc32/bin/arm-linux-androideabi- \
            CLANG_TRIPLE=aarch64-linux-gnu- \
            LD=ld.lld HOSTLD=ld.lld \
            KCFLAGS=-Wno-error \
            O=out"
          
          # è·å–å‚æ•°
          SYSTEM="${{ github.event.inputs.compiled_system }}"
          KSU="${{ github.event.inputs.kernelsu_variant }}"
          KPM="${{ github.event.inputs.kpm_enable }}"
          VERSION="${{ github.event.inputs.kernel_version }}"
          
          # ç”Ÿæˆè®¾å¤‡é…ç½®
          echo "ğŸ”§ Generating ${DEVICE} configuration... (æ­£åœ¨ç”Ÿæˆ ${DEVICE} çš„é…ç½®)"
          make $MAKE_ARGS -j$(nproc --all) ${DEVICE}_defconfig
          
          # å¼€å¯ä¸€äº›é™„åŠ ä¼˜åŒ–é…ç½®
          echo "ğŸ”§ Applying basic optimized configurations... (åº”ç”¨åŸºæœ¬ä¼˜åŒ–é…ç½®)"
          scripts/config --file out/.config \
            -e KALLSYMS \
            -e KALLSYMS_ALL \
            -e KPROBES \
            -e HAVE_KPROBES \
            -e KPROBE_EVENTS \
            -e TMPFS_XATTR=y \
            -e TMPFS_POSIX_ACL \
            -e IP_NF_TARGET_TTL \
            -e IP6_NF_TARGET_HL \
            -e IP6_NF_MATCH_HL \
            -e UCLAMP_TASK \
            -e TCP_CONG_ADVANCED \
            -e TCP_CONG_BIC \
            -e TCP_CONG_CUBIC \
            -e TCP_CONG_WESTWOOD \
            -e TCP_CONG_HTCP \
            -e TCP_CONG_HSTCP \
            -e TCP_CONG_HYBLA \
            -e TCP_CONG_VEGAS \
            -e TCP_CONG_NV \
            -e TCP_CONG_SCALABLE \
            -e TCP_CONG_LP \
            -e TCP_CONG_VENO \
            -e TCP_CONG_YEAH \
            -e TCP_CONG_ILLINOIS \
            -e TCP_CONG_DCTCP \
            -e TCP_CONG_CDG \
            -e TCP_CONG_BBR \
            -e DEFAULT_BBR \
            -e NET_SCHED \
            -e NET_SCH_HTB \
            -e NET_SCH_HFSC \
            -e NET_SCH_PRIO \
            -e NET_SCH_MULTIQ \
            -e NET_SCH_RED \
            -e NET_SCH_SFB \
            -e NET_SCH_SFQ \
            -e NET_SCH_TEQL \
            -e NET_SCH_TBF \
            -e NET_SCH_CBS \
            -e NET_SCH_ETF \
            -e NET_SCH_TAPRIO \
            -e NET_SCH_GRED \
            -e NET_SCH_NETEM \
            -e NET_SCH_DRR \
            -e NET_SCH_MQPRIO \
            -e NET_SCH_SKBPRIO \
            -e NET_SCH_CHOKE \
            -e NET_SCH_QFQ \
            -e NET_SCH_CODEL \
            -e NET_SCH_FQ_CODEL \
            -e NET_SCH_CAKE \
            -e NET_SCH_FQ \
            -e NET_SCH_HHF \
            -e NET_SCH_PIE \
            -e NET_SCH_FQ_PIE \
            -e NET_SCH_INGRESS \
            -e NET_SCH_PLUG \
            -e NET_SCH_ETS \
            -e NET_SCH_FIFO \
            -e NET_SCH_DEFAULT \
            -e DEFAULT_FQ \
            -e MQ_IOSCHED_DEADLINE \
            -e MQ_IOSCHED_KYBER \
            -e IOSCHED_BFQ \
            -e BFQ_GROUP_IOSCHED \
            -e ENERGY_MODEL \
            -e CPU_IDLE \
            -e CPU_IDLE_GOV_MENU \
            -e CPU_IDLE_GOV_TEO \
            -e ARM_PSCI_CPUIDLE \
            -e CPU_FREQ \
            -e CPU_FREQ_STAT \
            -e CPU_FREQ_TIMES \
            -e CPU_FREQ_GOV_POWERSAVE \
            -e CPU_FREQ_GOV_CONSERVATIVE \
            -e CPU_FREQ_GOV_USERSPACE \
            -e CPU_FREQ_GOV_ONDEMAND \
            -e ZRAM \
            -e ZSMALLOC \
            -e ZRAM_WRITEBACK \
            -e CRYPTO_LZ4 \
            -e CRYPTO_LZ4HC \
            -e CRYPTO_LZ4K \
            -e CRYPTO_LZ4KD \
            -e CRYPTO_ZSTD \
            -e CRYPTO_842 \
            -e CRYPTO_LZO \
            -e CRYPTO_DEFLATE \
            -e ZRAM_DEF_COMP_LZ4KD \
            -e SWAP \
            -e ZSWAP \
            -e ANDROID_SIMPLE_LMK \
            -e CPU_FREQ_GOV_SCHEDHORIZON \
            -e CPU_FREQ_DEFAULT_GOV_SCHEDHORIZON \
            --set-val LITTLE_CPU_MASK 15 \
            --set-val BIG_CPU_MASK 112 \
            --set-val PRIME_CPU_MASK 128 \
            -e LRU_GEN \
            -e LRU_GEN_ENABLED
            
          # æ ¹æ®ç³»ç»Ÿç±»å‹ä¿®æ”¹é…ç½®
          if [ "$SYSTEM" == "MIUI" ]; then
              echo "ğŸ”§ Apply MIUI specific configurations... (åº”ç”¨ MIUI ç‰¹å®šé…ç½®)"
              scripts/config --file out/.config \
                  --set-str STATIC_USERMODEHELPER_PATH /system/bin/micd \
                  -e PERF_CRITICAL_RT_TASK \
                  -e SF_BINDER \
                  -e OVERLAY_FS \
                  -d DEBUG_FS \
                  -e MIGT \
                  -e MIGT_ENERGY_MODEL \
                  -e MIHW \
                  -e PACKAGE_RUNTIME_INFO \
                  -e BINDER_OPT \
                  -e KPERFEVENTS \
                  -e MILLET \
                  -e PERF_HUMANTASK \
                  -d LTO_CLANG \
                  -d LOCALVERSION_AUTO \
                  -e SF_BINDER \
                  -e XIAOMI_MIUI \
                  -d MI_MEMORY_SYSFS \
                  -e TASK_DELAY_ACCT \
                  -e MIUI_ZRAM_MEMORY_TRACKING \
                  -d CONFIG_MODULE_SIG_SHA512 \
                  -d CONFIG_MODULE_SIG_HASH \
                  -e MI_FRAGMENTION \
                  -e PERF_HELPER \
                  -e BOOTUP_RECLAIM \
                  -e MI_RECLAIM \
                  -e RTMM
          fi
            
          # æ ¹æ® KernelSU å˜ä½“ä¿®æ”¹é…ç½®
          if [ "$KSU" == "SukiSU-Ultra" ] || [ "$KSU" == "RKSU" ]; then
              echo "ğŸ”§ Applying SukiSU-Ultra & RKSU Configuration... (åº”ç”¨ SukiSU-Ultra & RKSU é…ç½®)"
              scripts/config --file out/.config \
                  -e KSU \
                  -e KSU_MANUAL_HOOK \
                  -e KSU_SUSFS \
                  -e KSU_SUSFS_HAS_MAGIC_MOUNT \
                  -d KSU_SUSFS_SUS_PATH \
                  -e KSU_SUSFS_SUS_MOUNT \
                  -e KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT \
                  -e KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT \
                  -e KSU_SUSFS_SUS_KSTAT \
                  -d KSU_SUSFS_SUS_OVERLAYFS \
                  -e KSU_SUSFS_TRY_UMOUNT \
                  -e KSU_SUSFS_AUTO_ADD_TRY_UMOUNT_FOR_BIND_MOUNT \
                  -e KSU_SUSFS_SPOOF_UNAME \
                  -e KSU_SUSFS_ENABLE_LOG \
                  -e KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS \
                  -e KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG \
                  -d KSU_SUSFS_OPEN_REDIRECT \
                  -d KSU_SUSFS_SUS_SU
          elif [ "$KSU" == "KernelSU" ]; then
              echo "ğŸ”§ Applying KernelSU Configuration... (åº”ç”¨ KernelSU é…ç½®)"
              scripts/config --file out/.config \
                  -e KSU
          fi
            
          # åˆ¤æ–­KPMæ˜¯å¦å¯ç”¨å¹¶å¼€å¯ç›¸å…³é…ç½®
          if [ "$KSU" == "SukiSU-Ultra" ] && [ "$KPM" == "enable" ]; then
              echo "ğŸ”§ Enabling KPM Configuration... (å¼€å¯ KPM é…ç½®)"
              scripts/config --file out/.config \
                  -e KPM
          fi
            
          # ä¿®æ”¹å†…æ ¸ç‰ˆæœ¬å·
          if [ ! -z "$VERSION" ]; then
              echo "ğŸ”§ è®¾ç½®è‡ªå®šä¹‰å†…æ ¸ç‰ˆæœ¬: $VERSION"
              sed -i "s/-dirty/-$VERSION/g" scripts/setlocalversion
          else
              echo "ğŸ”§ ä½¿ç”¨é»˜è®¤ç‰ˆæœ¬åç¼€: -Yun"
              sed -i "s/-dirty/-Yun/g" scripts/setlocalversion
          fi

          FULL_VERSION="$VERSION"
          if [ ! -z "$FULL_VERSION" ]; then
            main_version=$(echo "$FULL_VERSION" | grep -oE '^[0-9]+(\.[0-9]+)*')
            custom_part=$(echo "$FULL_VERSION" | grep -oE '(-[a-zA-Z0-9]+)*$')
            makefile_path="$KERNEL_SOURCE/Makefile"
            IFS='.' read -ra version_parts <<< "$main_version"
            sed -i "2s/.*/VERSION = ${version_parts[0]}/" "$makefile_path"
            if [ -n "${version_parts[1]}" ]; then
              sed -i "3s/.*/PATCHLEVEL = ${version_parts[1]}/" "$makefile_path"
            fi
            if [ -n "${version_parts[2]}" ]; then
              sed -i "4s/.*/SUBLEVEL = ${version_parts[2]}/" "$makefile_path"
            fi

            sed -i "s/echo \"\$res\"/echo \"${custom_part}\"/g" "$KERNEL_SOURCE/scripts/setlocalversion"
          fi
            
          # å¼€å§‹æ„å»º
          echo "ğŸš€ Start building the kernel... (å¼€å§‹æ„å»ºå†…æ ¸)"
          make $MAKE_ARGS -j$(nproc --all) 2>&1 | tee build.log
            
          # éªŒè¯æ„å»ºç»“æœ
          if [ -f "$KERNEL_SOURCE/out/arch/arm64/boot/Image" ]; then
              echo "âœ… Kernel Build Successful (å†…æ ¸æ„å»ºæˆåŠŸ)"
          else
              echo "âŒ Kernel build failure (å†…æ ¸æ„å»ºå¤±è´¥)"
              echo "error log (é”™è¯¯æ—¥å¿—):"
              tail -n 100 build.log
              exit 1
          fi
            
          # æ˜¾ç¤º ccache ç»Ÿè®¡ä¿¡æ¯
          echo "ğŸ“Š CCache Statistics (CCache ç»Ÿè®¡ä¿¡æ¯):"
          ccache --show-stats

      - name: ğŸ› ï¸ KPM Patching Image Files (KPM ä¿®è¡¥ Image æ–‡ä»¶)
        run: |
          KSU_VARIANT="${{ github.event.inputs.kernelsu_variant }}"
          KPM_ENABLE="${{ github.event.inputs.kpm_enable }}"
          
          if [ "$KSU_VARIANT" == "SukiSU-Ultra" ] && [ "$KPM_ENABLE" == "enable" ]; then
            echo "ğŸ› ï¸ æ­£åœ¨ä¿®è¡¥ Image æ–‡ä»¶..."
            cd "$KERNEL_SOURCE/out/arch/arm64/boot"
            curl -LSs "https://raw.githubusercontent.com/ShirkNeko/SukiSU_patch/refs/heads/main/kpm/patch_linux" -o patch
            chmod 777 patch
            ./patch
            if [ $? -eq 0 ]; then
              rm -f Image
              mv oImage Image
              echo "âœ… Image file repair complete (Image æ–‡ä»¶ä¿®è¡¥å®Œæˆ)"
            else
              echo "âŒ KPM Patch Failed, Use Original Image (KPM ä¿®è¡¥å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹ Image)"
            fi
          else 
            echo "â„¹ï¸ KPM is not enabled or KernelSU variants do not support KPM. (KPM æœªå¯ç”¨æˆ– KernelSU å˜ä½“ä¸æ”¯æŒ KPM)"
          fi

      - name: ğŸ“ Setting Version Variables (è®¾ç½®ç‰ˆæœ¬å˜é‡)
        run: |
          cd "$KERNEL_SOURCE"
          
          # è·å– Git Commit å“ˆå¸Œå€¼
          GIT_COMMIT_SHORT=$(git rev-parse --short=6 HEAD)
          echo "GIT_COMMIT_ID=$GIT_COMMIT_SHORT" >> $GITHUB_ENV
          
          # è·å–æ—¥æœŸ
          BUILD_DATE=$(date +%Y%m%d)
          echo "BUILD_DATE=$BUILD_DATE" >> $GITHUB_ENV

      - name: ğŸ“¦ Package kernel to AnyKernel3 (æ‰“åŒ…å†…æ ¸åˆ° AnyKernel3)
        run: |
          # å®šä¹‰å˜é‡
          SYSTEM="${{ github.event.inputs.compiled_system }}"
          KSU="${{ github.event.inputs.kernelsu_variant }}"
          BUILD_TYPE="${{ github.event.inputs.build_type }}"
          BUILD_ID="${{ env.GIT_COMMIT_ID }}"
          BUILD_DATE="${{ env.BUILD_DATE }}"
          ZIP_NAME="${DEVICE}_${KSU}_${SYSTEM}_${BUILD_DATE}_${BUILD_ID}_${BUILD_TYPE}.zip"
          
          echo "ğŸ“¦ Create AnyKernel3 package (åˆ›å»º AnyKernel3 åˆ·æœºåŒ…)"
          
          # åˆ›å»ºç›®å½•å¹¶å…‹éš† AnyKernel3
          mkdir -p "$WORKDIR/ak3_out"
          cd "$WORKDIR/ak3_out"
          git clone https://github.com/liyafe1997/AnyKernel3.git --depth=1
          cd AnyKernel3
          
          # åˆ é™¤ä¸éœ€è¦çš„æ–‡ä»¶
          rm -rf .git .github README.md
          
          # å¤åˆ¶å†…æ ¸é•œåƒ
          cp "$KERNEL_SOURCE/out/arch/arm64/boot/Image" ./
          
          # æ‰“åŒ…
          echo "ğŸ“¦ Flashing package being created (æ­£åœ¨åˆ›å»ºåˆ·æœºåŒ…): $ZIP_NAME"
          zip -r "$ZIP_NAME" .
          
          if [ -f "$ZIP_NAME" ]; then
            echo "âœ… Flip package created successfully (åˆ·æœºåŒ…åˆ›å»ºæˆåŠŸ): $ZIP_NAME"
            ls -lh "$ZIP_NAME"
            mv "$ZIP_NAME" ..
          else
            echo "âŒ Brush package creation failed (åˆ·æœºåŒ…åˆ›å»ºå¤±è´¥)"
            exit 1
          fi
          
      - name: ğŸ“¤ Upload compilation results (ä¸Šä¼ ç¼–è¯‘ç»“æœ)
        uses: actions/upload-artifact@v4
        with:
          name: Kernel-${{ matrix.device }}
          path: ${{ github.workspace }}/ak3_out/*.zip

  release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - name: ğŸ“¥ Download all zip artifacts (ä¸‹è½½æ‰€æœ‰ zip æ„å»ºäº§ç‰©)
      uses: actions/download-artifact@v4
      with:
        path: out

    - name: ğŸ“ Preparing files for release (å‡†å¤‡å‘å¸ƒæ–‡ä»¶)
      run: |
        mkdir -p release
        cd /home/runner/work/kernel_xiaomi_sm8250_mod/kernel_xiaomi_sm8250_mod/out
        device_list=()
        for dir in */; do
          device_name=$(echo "$dir" | sed 's/Kernel-//' | sed 's/\/$//')
          echo "Found device: $device_name"
          device_list+=("$device_name")
          cd "$dir"
        for zip_file in *; do
          if [[ -f "$zip_file" && "$zip_file" == *.zip ]]; then
          mv "$zip_file" /home/runner/work/kernel_xiaomi_sm8250_mod/kernel_xiaomi_sm8250_mod/release
        fi
          done
          cd ..
        done
        TARGET_DEVICES=$(echo "${device_list[*]}" | tr ' ' '-')
        echo "TARGET_DEVICES=$TARGET_DEVICES" >> $GITHUB_ENV

    - name: ğŸ“… Setting date variables (è®¾ç½®æ—¥æœŸå˜é‡)
      run: |
        echo "RELEASE_DATE=$(date +%Y%m%d)" >> $GITHUB_ENV
        REPO_URL="https://github.com/yspbwx2010/kernel_xiaomi_sm8250_mod.git"
        GIT_COMMIT_ID=$(git ls-remote $REPO_URL HEAD | cut -f1)
        echo "GIT_COMMIT_ID=$GIT_COMMIT_ID" >> $GITHUB_ENV
          
    - name: ğŸ“¤ Post to Release (å‘å¸ƒåˆ° Release)
      uses: softprops/action-gh-release@v1
      with:
        files: /home/runner/work/kernel_xiaomi_sm8250_mod/kernel_xiaomi_sm8250_mod/release/*.zip
        name: Kernel_ï¼ˆ${{ env.TARGET_DEVICES }}ï¼‰_${{ github.event.inputs.kernelsu_variant }}_${{ github.event.inputs.compiled_system }}_${{ env.RELEASE_DATE }}_${{ env.GIT_COMMIT_ID }}_${{ github.event.inputs.build_type }}
        tag_name: Kernel_ï¼ˆ${{ env.TARGET_DEVICES }}ï¼‰_${{ github.event.inputs.kernelsu_variant }}_${{ github.event.inputs.compiled_system }}_${{ env.RELEASE_DATE }}_${{ env.GIT_COMMIT_ID }}
        body: |
          ## ğŸ“±kernel build information | å†…æ ¸æ„å»ºä¿¡æ¯
      
          ### ğŸŒ è‹±æ–‡ | English
          - **Target Device:** ${{ env.TARGET_DEVICES }}
          - **Compiled System:** ${{ github.event.inputs.compiled_system }}
          - **KernelSU Variant:** ${{ github.event.inputs.kernelsu_variant }}
          - **KPM Support:** ${{ github.event.inputs.kpm_enable }}
          - **Build Type:** ${{ github.event.inputs.build_type }}
          - **Build Date:** ${{ env.RELEASE_DATE }}
          - **Commit ID:** ${{ env.GIT_COMMIT_ID }}
      
          ### ğŸ‡¨ğŸ‡³ ä¸­æ–‡ | Chinese
          - **ç›®æ ‡æœºå‹:** ${{ env.TARGET_DEVICES }}
          - **é€‚ç”¨ç³»ç»Ÿ:** ${{ github.event.inputs.compiled_system }}
          - **KernelSUå˜ä½“:** ${{ github.event.inputs.kernelsu_variant }}
          - **KPMæ”¯æŒ:** ${{ github.event.inputs.kpm_enable }}
          - **æ„å»ºç±»å‹:** ${{ github.event.inputs.build_type }}
          - **æ„å»ºæ—¥æœŸ:** ${{ env.RELEASE_DATE }}
          - **æäº¤ID:** ${{ env.GIT_COMMIT_ID }}
      
          ### ğŸ“‹ å®‰è£…è¯´æ˜ | Installation Guide
          1. ä¸‹è½½å¯¹åº”æœºå‹çš„åˆ·æœºåŒ…
          2. è¿›å…¥Recoveryæ¨¡å¼
          3. é€šè¿‡Recoveryåˆ·å…¥åˆ·æœºåŒ…
          4. é‡å¯è®¾å¤‡
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
