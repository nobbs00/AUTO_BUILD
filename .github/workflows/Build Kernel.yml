name: Optimized Build for Xiaomi 10 Pro (cmi)
on:
  workflow_dispatch:
    inputs:
      phone:
        description: 'é€‰æ‹©æ‰‹æœºå‹å·ï¼š'
        required: true
        default: 'MI10_Pro'
        type: choice
        options:
          - MI10_Pro

jobs:
  build_job:
    runs-on: ubuntu-22.04
    env:
      CI: "false"
      KERNEL_DIR: ${{ github.workspace }}/kernel_workspace/android_kernel
      CLANG_VERSION: "21.0.0git-20250523"
      ARCH: arm64
      SUBARCH: arm64

    steps:
    
      - name: å®‰è£…ç¼–è¯‘ä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libssl-dev ncurses-dev xmlto kmod flex bison \
            zlib1g-dev libelf-dev libdw-dev libiberty-dev \
            python3-dev libcap-dev bc rsync lz4 liblz4-tool \
            dwarves libncurses5-dev libpci-dev pigz gcc-aarch64-linux-gnu \
            gcc-arm-linux-gnueabi \
            binutils-aarch64-linux-gnu \
            binutils-arm-linux-gnueabi

      - name: 1.ä¸‹è½½ç¼–è¯‘å·¥å…·
        run: |
          mkdir -p $GITHUB_WORKSPACE/kernel_workspace
          cd $GITHUB_WORKSPACE/kernel_workspace
          wget -q https://github.com/ZyCromerZ/Clang/releases/download/${CLANG_VERSION}-release/Clang-${CLANG_VERSION}.tar.gz
          mkdir -p clang
          tar --use-compress-program=pigz -xf Clang-${CLANG_VERSION}.tar.gz -C clang

      - name: 2.å…‹éš†æºç ä¸è¡¥ä¸
        run: |
          cd $GITHUB_WORKSPACE/kernel_workspace
          git clone https://github.com/nobbs00/nikokernel_xiaomi_sm8250_mod_new.git --depth=1 android_kernel
          git clone https://github.com/nobbs00/AnyKernel3.git src

      - name: 3.å®‰è£…sukisu-kernel
        run: |
          cd ${KERNEL_DIR}
          curl -LSs "https://raw.githubusercontent.com/ShirkNeko/SukiSU-Ultra/susfs-dev/kernel/setup.sh" | bash -s susfs-dev

      - name: 4.å¼€å§‹æ„å»º
        run: |
          export PATH=${KERNEL_DIR}/../clang/bin:$PATH
          MAKE_ARGS="ARCH=arm64 SUBARCH=arm64 LLVM=1 LLVM_IAS=1 \
            CROSS_COMPILE=$TOOLCHAIN_DIR/gcc/gcc64/bin/aarch64-linux-android- \
            CROSS_COMPILE_COMPAT=$TOOLCHAIN_DIR/gcc/gcc32/bin/arm-linux-androideabi- \
            CROSS_COMPILE_ARM32=$TOOLCHAIN_DIR/gcc/gcc32/bin/arm-linux-androideabi- \
            CLANG_TRIPLE=aarch64-linux-gnu- \
            LD=ld.lld HOSTLD=ld.lld \
            KCFLAGS=-Wno-error \
            O=out"
          export CLANG_TRIPLE=aarch64-linux-gnu-
          export CROSS_COMPILE=aarch64-linux-gnu-
          export CROSS_COMPILE_ARM32=arm-linux-gnueabi-
          export KCFLAGS="\
            -march=armv8.2-a+crypto+dotprod \
            -mcpu=cortex-a77 \
            -fno-strict-aliasing \
            -fno-common \
            -pipe \
            -Wno-error -mllvm -import-instr-limit=30"

          export LDFLAGS="\
            -plugin ${KERNEL_DIR}/../clang/lib/LLVMgold.so"

          cd ${KERNEL_DIR}
          

          # è®¾å¤‡é…ç½®
          case "${{ github.event.inputs.phone }}" in
              "MI10_Pro")
                  DEFCONFIG="cmi_defconfig"
                  ;;
              *)
                  echo "é”™è¯¯ï¼šæœªçŸ¥è®¾å¤‡"
                  exit 1
                  ;;
          esac

          # ç”Ÿæˆé…ç½®
          make ARCH=${ARCH} SUBARCH=${SUBARCH} $MAKE_ARGS $DEFCONFIG

          # ç¡¬ä»¶ç‰¹æ€§ä¼˜åŒ–é…ç½®
          scripts/config --file out/.config \
            -e KALLSYMS \
            -e KALLSYMS_ALL \
            -e KPROBES \
            -e HAVE_KPROBES \
            -e KPROBE_EVENTS \
            -e TMPFS_XATTR=y \
            -e TMPFS_POSIX_ACL \
            -e IP_NF_TARGET_TTL \
            -e IP6_NF_TARGET_HL \
            -e IP6_NF_MATCH_HL \
            -e UCLAMP_TASK \
            -e TCP_CONG_ADVANCED \
            -e TCP_CONG_BIC \
            -e TCP_CONG_CUBIC \
            -e TCP_CONG_WESTWOOD \
            -e TCP_CONG_HTCP \
            -e TCP_CONG_HSTCP \
            -e TCP_CONG_HYBLA \
            -e TCP_CONG_VEGAS \
            -e TCP_CONG_NV \
            -e TCP_CONG_SCALABLE \
            -e TCP_CONG_LP \
            -e TCP_CONG_VENO \
            -e TCP_CONG_YEAH \
            -e TCP_CONG_ILLINOIS \
            -e TCP_CONG_DCTCP \
            -e TCP_CONG_CDG \
            -e TCP_CONG_BBR \
            -e DEFAULT_BBR \
            -e NET_SCHED \
            -e NET_SCH_HTB \
            -e NET_SCH_HFSC \
            -e NET_SCH_PRIO \
            -e NET_SCH_MULTIQ \
            -e NET_SCH_RED \
            -e NET_SCH_SFB \
            -e NET_SCH_SFQ \
            -e NET_SCH_TEQL \
            -e NET_SCH_TBF \
            -e NET_SCH_CBS \
            -e NET_SCH_ETF \
            -e NET_SCH_TAPRIO \
            -e NET_SCH_GRED \
            -e NET_SCH_NETEM \
            -e NET_SCH_DRR \
            -e NET_SCH_MQPRIO \
            -e NET_SCH_SKBPRIO \
            -e NET_SCH_CHOKE \
            -e NET_SCH_QFQ \
            -e NET_SCH_CODEL \
            -e NET_SCH_FQ_CODEL \
            -e NET_SCH_CAKE \
            -e NET_SCH_FQ \
            -e NET_SCH_HHF \
            -e NET_SCH_PIE \
            -e NET_SCH_FQ_PIE \
            -e NET_SCH_INGRESS \
            -e NET_SCH_PLUG \
            -e NET_SCH_ETS \
            -e NET_SCH_FIFO \
            -e NET_SCH_DEFAULT \
            -e DEFAULT_FQ \
            -e MQ_IOSCHED_DEADLINE \
            -e MQ_IOSCHED_KYBER \
            -e IOSCHED_BFQ \
            -e BFQ_GROUP_IOSCHED \
            -e ENERGY_MODEL \
            -e CPU_IDLE \
            -e CPU_IDLE_GOV_MENU \
            -e CPU_IDLE_GOV_TEO \
            -e ARM_PSCI_CPUIDLE \
            -e CPU_FREQ \
            -e CPU_FREQ_STAT \
            -e CPU_FREQ_TIMES \
            -e CPU_FREQ_GOV_POWERSAVE \
            -e CPU_FREQ_GOV_CONSERVATIVE \
            -e CPU_FREQ_GOV_USERSPACE \
            -e CPU_FREQ_GOV_ONDEMAND \
            -e ZRAM \
            -e ZSMALLOC \
            -e ZRAM_WRITEBACK \
            -e CRYPTO_LZ4HC \
            -e CRYPTO_LZ4K \
            -e CRYPTO_LZ4KD \
            -e CRYPTO_ZSTD \
            -e CRYPTO_842 \
            -e CRYPTO_LZO \
            -e CRYPTO_DEFLATE \
            -e ZRAM_DEF_COMP_LZ4KD \
            -e SWAP \
            -e ZSWAP \
            -e ANDROID_SIMPLE_LMK \
            -e CPU_FREQ_GOV_SCHEDHORIZON \
            -e CPU_FREQ_DEFAULT_GOV_SCHEDHORIZON \
            --set-val LITTLE_CPU_MASK 15 \
            --set-val BIG_CPU_MASK 112 \
            --set-val PRIME_CPU_MASK 128 \
            -e LRU_GEN \
            -e LRU_GEN_ENABLED


          # åº”ç”¨MIUIä¼˜åŒ–é…ç½®
          echo "ğŸ”§ åº”ç”¨MIUIä¼˜åŒ–é…ç½®..."
          scripts/config --file out/.config \
            --set-str STATIC_USERMODEHELPER_PATH /system/bin/micd \
                  -e PERF_CRITICAL_RT_TASK \
                  -e SF_BINDER \
                  -e OVERLAY_FS \
                  -e DEBUG_FS \
                  -e MIGT \
                  -e MIGT_ENERGY_MODEL \
                  -e MIHW \
                  -e PACKAGE_RUNTIME_INFO \
                  -e BINDER_OPT \
                  -e KPERFEVENTS \
                  -e MILLET \
                  -e PERF_HUMANTASK \
                  -d LTO_CLANG \
                  -e LOCALVERSION_AUTO \
                  -e SF_BINDER \
                  -e XIAOMI_MIUI \
                  -d MI_MEMORY_SYSFS \
                  -e TASK_DELAY_ACCT \
                  -e MIUI_ZRAM_MEMORY_TRACKING \
                  -d CONFIG_MODULE_SIG_SHA512 \
                  -d CONFIG_MODULE_SIG_HASH \
                  -e MI_FRAGMENTION \
                  -e PERF_HELPER \
                  -e BOOTUP_RECLAIM \
                  -e MI_RECLAIM \
                  -e RTMM

          # è¿½åŠ KernelSUé…ç½®åˆ°å½“å‰é…ç½®
              scripts/config --file out/.config \
                  -e KPM \
                  -e KSU \
                  -e KSU_MANUAL_HOOK \
                  -e KSU_SUSFS \
                  -e KSU_SUSFS_HAS_MAGIC_MOUNT \
                  -d KSU_SUSFS_SUS_PATH \
                  -e KSU_SUSFS_SUS_MOUNT \
                  -e KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT \
                  -e KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT \
                  -e KSU_SUSFS_SUS_KSTAT \
                  -d KSU_SUSFS_SUS_OVERLAYFS \
                  -e KSU_SUSFS_TRY_UMOUNT \
                  -e KSU_SUSFS_AUTO_ADD_TRY_UMOUNT_FOR_BIND_MOUNT \
                  -e KSU_SUSFS_SPOOF_UNAME \
                  -e KSU_SUSFS_ENABLE_LOG \
                  -e KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS \
                  -e KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG \
                  -d KSU_SUSFS_OPEN_REDIRECT \
                  -d KSU_SUSFS_SUS_SU

            
          # å¼€å§‹æ„å»º
          echo "ğŸš€ Start building the kernel... (å¼€å§‹æ„å»ºå†…æ ¸)"
          make $MAKE_ARGS -j$(nproc --all) 2>&1 | tee build.log
            
          # éªŒè¯æ„å»ºç»“æœ
          if [ -f "$KERNEL_SOURCE/out/arch/arm64/boot/Image" ]; then
              echo "âœ… Kernel Build Successful (å†…æ ¸æ„å»ºæˆåŠŸ)"
          else
              echo "âŒ Kernel build failure (å†…æ ¸æ„å»ºå¤±è´¥)"
              echo "error log (é”™è¯¯æ—¥å¿—):"
              tail -n 100 build.log
              exit 1
          fi

      - name: ğŸ› ï¸ KPM Patching Image Files (KPM ä¿®è¡¥ Image æ–‡ä»¶)
        run: |
          KSU_VARIANT="${{ github.event.inputs.kernelsu_variant }}"
          KPM_ENABLE="${{ github.event.inputs.kpm_enable }}"
          
          if [ "$KSU_VARIANT" == "SukiSU-Ultra" ] && [ "$KPM_ENABLE" == "enable" ]; then
            echo "ğŸ› ï¸ æ­£åœ¨ä¿®è¡¥ Image æ–‡ä»¶..."
            cd "$KERNEL_SOURCE/out/arch/arm64/boot"
            curl -LSs "https://raw.githubusercontent.com/ShirkNeko/SukiSU_patch/refs/heads/main/kpm/patch_linux" -o patch
            chmod 777 patch
            ./patch
            if [ $? -eq 0 ]; then
              rm -f Image
              mv oImage Image
              echo "âœ… Image file repair complete (Image æ–‡ä»¶ä¿®è¡¥å®Œæˆ)"
            else
              echo "âŒ KPM Patch Failed, Use Original Image (KPM ä¿®è¡¥å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹ Image)"
            fi
          else 
            echo "â„¹ï¸ KPM is not enabled or KernelSU variants do not support KPM. (KPM æœªå¯ç”¨æˆ– KernelSU å˜ä½“ä¸æ”¯æŒ KPM)"
          fi

      - name: 5.æŸ¥çœ‹æˆæœ
        run: |
            cd $GITHUB_WORKSPACE/kernel_workspace/android_kernel/out/arch/arm64/boot
            ls
            strings Image | grep "Linux version"
            cp Image $GITHUB_WORKSPACE/kernel_workspace/src/

      - name: 6.ä¸Šä¼ åˆ·å…¥åŒ…
        uses: actions/upload-artifact@v4
        with:
          name: cmi_${{ github.event.inputs.phone}}
          path: kernel_workspace/src/*
          retention-days: 3
