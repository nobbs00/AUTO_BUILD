name: Build Kernel
permissions:
  contents: write
  actions: write

on:
  workflow_dispatch:
    inputs:
      target_devices:
        description: 'target device (目标设备)'
        required: true
        type: choice

      compiled_system:
        description: 'Applicable systems (适用系统)'
        required: true
        type: choice
        default: 'MIUI'

      kernelsu_variant:
        description: 'KernelSU variants (KernelSU 版本)'
        required: true
        type: choice
        default: 'SukiSU-Ultra'

      kpm_enable:
        description: 'Is KPM support enabled? (是否启用 KPM 支持?)'
        required: true
        type: choice
        default: 'enable'

      kernel_version:
        description: 'Customizing the kernel version number (自定义内核版本号)'
        required: false
        type: string
        default: ''
      build_type:
        description: 'Kernel Build Type (内核构建类型)'
        required: true
        type: choice
        default: 'Release'

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - id: set-matrix
        run: |
          DEVICES="${{ github.event.inputs.target_devices }}"
          if [ "$DEVICES" == "all" ]; then
            DEVICES="cmi"
          fi
          DEVICES_JSON="[$(echo $DEVICES | sed 's/,/","/g' | sed 's/.*/"&"/')]"
          echo "matrix={\"device\":$DEVICES_JSON}" >> $GITHUB_OUTPUT

  build:
    needs: prepare
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
    strategy:
      matrix: ${{fromJson(needs.prepare.outputs.matrix)}}
      fail-fast: false
    env:
      CCACHE_COMPILERCHECK: "%compiler% -dumpmachine; %compiler% -dumpversion"
      CCACHE_NOHASHDIR: "true"
      CCACHE_HARDLINK: "true"
      WORKDIR: "${{ github.workspace }}"
      KERNEL_SOURCE: "${{ github.workspace }}/kernel_source"
      TOOLCHAIN_DIR: "${{ github.workspace }}/toolchain"
      DEVICE: "${{ matrix.device }}"

    steps:
      - name: 📢 Build Information (构建信息)
        run: |
          echo "设备: ${DEVICE} | 系统: ${{ github.event.inputs.compiled_system }}"
          echo "KernelSU变体: ${{ github.event.inputs.kernelsu_variant }} | KPM: ${{ github.event.inputs.kpm_enable }}"
          echo "构建类型: ${{ github.event.inputs.build_type }}"
          KSU="${{ github.event.inputs.kernelsu_variant }}"
          KPM="${{ github.event.inputs.kpm_enable }}"
          VERSION="${{ github.event.inputs.kernel_version }}"

      - name: 🚀 Maximize build space (最大化构建空间)
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192
          temp-reserve-mb: 2048
          swap-size-mb: 8192
          remove-dotnet: "true"
          remove-android: "true"
          remove-haskell: "true"
          remove-codeql: "true"

      - name: 📦 Installation of dependencies (安装依赖)
        run: |
          echo "正在安装构建依赖..."
          sudo apt update && sudo apt upgrade -y
          sudo apt install -y \
            bc binutils-dev bison build-essential ca-certificates ccache cmake curl file flex \
            git libelf-dev libssl-dev make ninja-build python3-dev texinfo u-boot-tools xz-utils \
            zlib1g-dev libncurses-dev wget zip cpio python3 python3-pip tree gcc clang lld llvm jq
          echo "✅ Dependency installation complete (依赖安装完成)"
          
      - name: ⚙️ Configuring ccache (配置 ccache)
        run: |
          mkdir -p ~/.cache
          ccache --version
          ccache --max-size=4G
          ccache --set-config=compression=true
          ccache --zero-stats
          echo "CCACHE_DIR=$HOME/.cache" >> $GITHUB_ENV
          
      - name: 📥 Restore ccache (恢复 ccache 缓存)
        uses: actions/cache@v4
        with:
          path: ~/.cache
          key: ccache-${{ github.event.inputs.compiled_system }}-${{ hashFiles('**/Makefile') }}
          restore-keys: |
            ccache-${{ github.event.inputs.compiled_system }}-
            ccache-
            
      - name: 1.下载编译工具
        run: |
          mkdir -p $GITHUB_WORKSPACE/kernel_workspace
          cd $GITHUB_WORKSPACE/kernel_workspace
          mkdir proton-clang
          cd proton-clang
          wget https://github.com/kdrag0n/proton-clang/archive/refs/tags/20210522.zip
          unzip 20210522.zip
          cd ..
          
      - name: 📥 Cloning kernel source code （克隆内核源码）
        run: |
          echo "正在克隆内核源码..."
          git clone https://github.com/nobbs00/nikokernel_xiaomi_sm8250_mod_new.git --depth=1 $KERNEL_SOURCE
          echo "✅ Kernel source code cloning complete (内核源码克隆完成)"

      - name: 📥 Caching toolchain (缓存工具链)
        id: cache-toolchain
        uses: actions/cache@v4
        with:
          path: ${{ env.TOOLCHAIN_DIR }}
          key: toolchain-clang-r547379-gcc-${{ hashFiles('**/*.sh') }}
          restore-keys: |
            toolchain-clang-r547379-gcc-
            toolchain-
            


      - name: ⚙️ Configuring KernelSU (配置 KernelSU)
        run: |
          cd "$KERNEL_SOURCE"
          
          KSU_VARIANT="${{ github.event.inputs.kernelsu_variant }}"
          
          echo "⚙️ Configure KernelSU Variants: $KSU_VARIANT (配置 KernelSU 变体: $KSU_VARIANT)"
          
          if [ "$KSU_VARIANT" == "SukiSU-Ultra" ]; then
            curl -LSs "https://raw.githubusercontent.com/ShirkNeko/SukiSU-Ultra/susfs-dev/kernel/setup.sh" | bash -s susfs-dev
          else
            echo "KernelSU Disabled (KernelSU 已禁用)"
          fi
          
          echo "✅ KernelSU configuration complete (KernelSU 配置完成)"
          
      - name: 🔨 Build the kernel (构建内核)
        run: |
          cd "$KERNEL_SOURCE"
          
          # 设置环境变量
          export PATH="$GITHUB_WORKSPACE/kernel_workspace/proton-clang/proton-clang-20210522/bin:$PATH"
          

          # 判断KPM是否启用并开启相关配置
          if [ "$KSU" == "SukiSU-Ultra" ] && [ "$KPM" == "enable" ]; then
              echo "🔧 Enabling KPM Configuration... (开启 KPM 配置)"
              scripts/config --file out/.config \
                  -e KPM
          fi
            
          # 修改内核版本号
          if [ ! -z "$VERSION" ]; then
              echo "🔧 设置自定义内核版本: $VERSION"
              sed -i "s/-dirty/-$VERSION/g" scripts/setlocalversion
          else
              echo "🔧 使用默认版本后缀: -Yun"
              sed -i "s/-dirty/-Yun/g" scripts/setlocalversion
          fi

          FULL_VERSION="$VERSION"
          if [ ! -z "$FULL_VERSION" ]; then
            main_version=$(echo "$FULL_VERSION" | grep -oE '^[0-9]+(\.[0-9]+)*')
            custom_part=$(echo "$FULL_VERSION" | grep -oE '(-[a-zA-Z0-9]+)*$')
            makefile_path="$KERNEL_SOURCE/Makefile"
            IFS='.' read -ra version_parts <<< "$main_version"
            sed -i "2s/.*/VERSION = ${version_parts[0]}/" "$makefile_path"
            if [ -n "${version_parts[1]}" ]; then
              sed -i "3s/.*/PATCHLEVEL = ${version_parts[1]}/" "$makefile_path"
            fi
            if [ -n "${version_parts[2]}" ]; then
              sed -i "4s/.*/SUBLEVEL = ${version_parts[2]}/" "$makefile_path"
            fi

            sed -i "s/echo \"\$res\"/echo \"${custom_part}\"/g" "$KERNEL_SOURCE/scripts/setlocalversion"
          fi
          
            # 开始构建内核
           sh ./release.sh cmi
            
          # 验证构建结果
          if [ -f "$KERNEL_SOURCE/out/arch/arm64/boot/Image" ]; then
              echo "✅ Kernel Build Successful (内核构建成功)"
          else
              echo "❌ Kernel build failure (内核构建失败)"
              echo "error log (错误日志):"
              tail -n 100 build.log
              exit 1
          fi
            
          # 显示 ccache 统计信息
          echo "📊 CCache Statistics (CCache 统计信息):"
          ccache --show-stats

      - name: 🛠️ KPM Patching Image Files (KPM 修补 Image 文件)
        run: |
          KSU_VARIANT="${{ github.event.inputs.kernelsu_variant }}"
          KPM_ENABLE="${{ github.event.inputs.kpm_enable }}"
          
          if [ "$KSU_VARIANT" == "SukiSU-Ultra" ] && [ "$KPM_ENABLE" == "enable" ]; then
            echo "🛠️ 正在修补 Image 文件..."
            cd "$KERNEL_SOURCE/out/arch/arm64/boot"
            curl -LSs "https://raw.githubusercontent.com/ShirkNeko/SukiSU_patch/refs/heads/main/kpm/patch_linux" -o patch
            chmod 777 patch
            ./patch
            if [ $? -eq 0 ]; then
              rm -f Image
              mv oImage Image
              echo "✅ Image file repair complete (Image 文件修补完成)"
            else
              echo "❌ KPM Patch Failed, Use Original Image (KPM 修补失败，使用原始 Image)"
            fi
          else 
            echo "ℹ️ KPM is not enabled or KernelSU variants do not support KPM. (KPM 未启用或 KernelSU 变体不支持 KPM)"
          fi

      - name: 📝 Setting Version Variables (设置版本变量)
        run: |
          cd "$KERNEL_SOURCE"
          
          # 获取 Git Commit 哈希值
          GIT_COMMIT_SHORT=$(git rev-parse --short=6 HEAD)
          echo "GIT_COMMIT_ID=$GIT_COMMIT_SHORT" >> $GITHUB_ENV
          
          # 获取日期
          BUILD_DATE=$(date +%Y%m%d)
          echo "BUILD_DATE=$BUILD_DATE" >> $GITHUB_ENV

      - name: 📦 Package kernel to AnyKernel3 (打包内核到 AnyKernel3)
        run: |
          # 定义变量
          SYSTEM="${{ github.event.inputs.compiled_system }}"
          KSU="${{ github.event.inputs.kernelsu_variant }}"
          BUILD_TYPE="${{ github.event.inputs.build_type }}"
          BUILD_ID="${{ env.GIT_COMMIT_ID }}"
          BUILD_DATE="${{ env.BUILD_DATE }}"
          ZIP_NAME="${DEVICE}_${KSU}_${SYSTEM}_${BUILD_DATE}_${BUILD_ID}_${BUILD_TYPE}.zip"
          
          echo "📦 Create AnyKernel3 package (创建 AnyKernel3 刷机包)"
          
          # 创建目录并克隆 AnyKernel3
          mkdir -p "$WORKDIR/ak3_out"
          cd "$WORKDIR/ak3_out"
          git clone https://github.com/liyafe1997/AnyKernel3.git --depth=1
          cd AnyKernel3
          
          # 删除不需要的文件
          rm -rf .git .github README.md
          
          # 复制内核镜像
          cp "$KERNEL_SOURCE/out/arch/arm64/boot/Image" ./
          
          # 打包
          echo "📦 Flashing package being created (正在创建刷机包): $ZIP_NAME"
          zip -r "$ZIP_NAME" .
          
          if [ -f "$ZIP_NAME" ]; then
            echo "✅ Flip package created successfully (刷机包创建成功): $ZIP_NAME"
            ls -lh "$ZIP_NAME"
            mv "$ZIP_NAME" ..
          else
            echo "❌ Brush package creation failed (刷机包创建失败)"
            exit 1
          fi
          
      - name: 📤 Upload compilation results (上传编译结果)
        uses: actions/upload-artifact@v4
        with:
          name: Kernel-${{ matrix.device }}
          path: ${{ github.workspace }}/ak3_out/*.zip

  release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - name: 📥 Download all zip artifacts (下载所有 zip 构建产物)
      uses: actions/download-artifact@v4
      with:
        path: out

    - name: 📝 Preparing files for release (准备发布文件)
      run: |
        mkdir -p release
        cd "$GITHUB_WORKSPACE/out"
        device_list=()
        for dir in */; do
          device_name=$(echo "$dir" | sed 's/Kernel-//' | sed 's/\/$//')
          echo "Found device: $device_name"
          device_list+=("$device_name")
          cd "$dir"
        for zip_file in *; do
          if [[ -f "$zip_file" && "$zip_file" == *.zip ]]; then
          mv "$zip_file" /home/runner/work/kernel_xiaomi_sm8250_mod_new/kernel_xiaomi_sm8250_mod_new/release
        fi
          done
          cd ..
        done
        TARGET_DEVICES=$(echo "${device_list[*]}" | tr ' ' '-')
        echo "TARGET_DEVICES=$TARGET_DEVICES" >> $GITHUB_ENV

    - name: 📅 Setting date variables (设置日期变量)
      run: |
        echo "RELEASE_DATE=$(date +%Y%m%d)" >> $GITHUB_ENV
        REPO_URL="https://github.com/yspbwx2010/kernel_xiaomi_sm8250_mod.git"
        GIT_COMMIT_ID=$(git ls-remote $REPO_URL HEAD | cut -f1)
        echo "GIT_COMMIT_ID=$GIT_COMMIT_ID" >> $GITHUB_ENV
          
    - name: 📤 Post to Release (发布到 Release)
      uses: softprops/action-gh-release@v1
      with:
        files: /home/runner/work/kernel_xiaomi_sm8250_mod/kernel_xiaomi_sm8250_mod/release/*.zip
        name: Kernel_（${{ env.TARGET_DEVICES }}）_${{ github.event.inputs.kernelsu_variant }}_${{ github.event.inputs.compiled_system }}_${{ env.RELEASE_DATE }}_${{ env.GIT_COMMIT_ID }}_${{ github.event.inputs.build_type }}
        tag_name: Kernel_（${{ env.TARGET_DEVICES }}）_${{ github.event.inputs.kernelsu_variant }}_${{ github.event.inputs.compiled_system }}_${{ env.RELEASE_DATE }}_${{ env.GIT_COMMIT_ID }}
        body: |
          ## 📱kernel build information | 内核构建信息
      
          ### 🌐 英文 | English
          - **Target Device:** ${{ env.TARGET_DEVICES }}
          - **Compiled System:** ${{ github.event.inputs.compiled_system }}
          - **KernelSU Variant:** ${{ github.event.inputs.kernelsu_variant }}
          - **KPM Support:** ${{ github.event.inputs.kpm_enable }}
          - **Build Type:** ${{ github.event.inputs.build_type }}
          - **Build Date:** ${{ env.RELEASE_DATE }}
          - **Commit ID:** ${{ env.GIT_COMMIT_ID }}
      
          ### 🇨🇳 中文 | Chinese
          - **目标机型:** ${{ env.TARGET_DEVICES }}
          - **适用系统:** ${{ github.event.inputs.compiled_system }}
          - **KernelSU变体:** ${{ github.event.inputs.kernelsu_variant }}
          - **KPM支持:** ${{ github.event.inputs.kpm_enable }}
          - **构建类型:** ${{ github.event.inputs.build_type }}
          - **构建日期:** ${{ env.RELEASE_DATE }}
          - **提交ID:** ${{ env.GIT_COMMIT_ID }}
      
          ### 📋 安装说明 | Installation Guide
          1. 下载对应机型的刷机包
          2. 进入Recovery模式
          3. 通过Recovery刷入刷机包
          4. 重启设备
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
